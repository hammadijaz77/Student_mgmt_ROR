import t from"util";import e from"normalize-path";import r from"buffer";import i from"./archivers/zip/util.js";import s from"./archivers/zip/constants.js";import n from"readable-stream";import o from"stream";import a from"buffer-crc32";import h from"crc32-stream";var f={};var p=f=function(){};p.prototype.getName=function(){};p.prototype.getSize=function(){};p.prototype.getLastModifiedDate=function(){};p.prototype.isDirectory=function(){};var c=f;var u="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var l={};var g=i;var y=1<<3;var _=1<<0;var m=1<<2;var v=1<<1;var d=1<<6;var E=1<<11;var S=l=function(){if(!((this||u)instanceof S))return new S;(this||u).descriptor=false;(this||u).encryption=false;(this||u).utf8=false;(this||u).numberOfShannonFanoTrees=0;(this||u).strongEncryption=false;(this||u).slidingDictionarySize=0;return this||u};S.prototype.encode=function(){return g.getShortBytes(((this||u).descriptor?y:0)|((this||u).utf8?E:0)|((this||u).encryption?_:0)|((this||u).strongEncryption?d:0))};S.prototype.parse=function(t,e){var r=g.getShortBytesValue(t,e);var i=new S;i.useDataDescriptor(0!==(r&y));i.useUTF8ForNames(0!==(r&E));i.useStrongEncryption(0!==(r&d));i.useEncryption(0!==(r&_));i.setSlidingDictionarySize(0!==(r&v)?8192:4096);i.setNumberOfShannonFanoTrees(0!==(r&m)?3:2);return i};S.prototype.setNumberOfShannonFanoTrees=function(t){(this||u).numberOfShannonFanoTrees=t};S.prototype.getNumberOfShannonFanoTrees=function(){return(this||u).numberOfShannonFanoTrees};S.prototype.setSlidingDictionarySize=function(t){(this||u).slidingDictionarySize=t};S.prototype.getSlidingDictionarySize=function(){return(this||u).slidingDictionarySize};S.prototype.useDataDescriptor=function(t){(this||u).descriptor=t};S.prototype.usesDataDescriptor=function(){return(this||u).descriptor};S.prototype.useEncryption=function(t){(this||u).encryption=t};S.prototype.usesEncryption=function(){return(this||u).encryption};S.prototype.useStrongEncryption=function(t){(this||u).strongEncryption=t};S.prototype.usesStrongEncryption=function(){return(this||u).strongEncryption};S.prototype.useUTF8ForNames=function(t){(this||u).utf8=t};S.prototype.usesUTF8ForNames=function(){return(this||u).utf8};var w=l;var D={};D={PERM_MASK:4095,FILE_TYPE_FLAG:61440,LINK_FLAG:40960,FILE_FLAG:32768,DIR_FLAG:16384,DEFAULT_LINK_PERM:511,DEFAULT_DIR_PERM:493,DEFAULT_FILE_PERM:420};var T=D;var I="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var B={};var L=r.Buffer;var O=t.inherits;var A=e;var C=c;var M=w;var F=T;var N=s;var b=i;var z=B=function(t){if(!((this||I)instanceof z))return new z(t);C.call(this||I);(this||I).platform=N.PLATFORM_FAT;(this||I).method=-1;(this||I).name=null;(this||I).size=0;(this||I).csize=0;(this||I).gpb=new M;(this||I).crc=0;(this||I).time=-1;(this||I).minver=N.MIN_VERSION_INITIAL;(this||I).mode=-1;(this||I).extra=null;(this||I).exattr=0;(this||I).inattr=0;(this||I).comment=null;t&&this.setName(t)};O(z,C);z.prototype.getCentralDirectoryExtra=function(){return this.getExtra()};z.prototype.getComment=function(){return null!==(this||I).comment?(this||I).comment:""};z.prototype.getCompressedSize=function(){return(this||I).csize};z.prototype.getCrc=function(){return(this||I).crc};z.prototype.getExternalAttributes=function(){return(this||I).exattr};z.prototype.getExtra=function(){return null!==(this||I).extra?(this||I).extra:N.EMPTY};z.prototype.getGeneralPurposeBit=function(){return(this||I).gpb};z.prototype.getInternalAttributes=function(){return(this||I).inattr};z.prototype.getLastModifiedDate=function(){return this.getTime()};z.prototype.getLocalFileDataExtra=function(){return this.getExtra()};z.prototype.getMethod=function(){return(this||I).method};z.prototype.getName=function(){return(this||I).name};z.prototype.getPlatform=function(){return(this||I).platform};z.prototype.getSize=function(){return(this||I).size};z.prototype.getTime=function(){return-1!==(this||I).time?b.dosToDate((this||I).time):-1};z.prototype.getTimeDos=function(){return-1!==(this||I).time?(this||I).time:0};z.prototype.getUnixMode=function(){return(this||I).platform!==N.PLATFORM_UNIX?0:this.getExternalAttributes()>>N.SHORT_SHIFT&N.SHORT_MASK};z.prototype.getVersionNeededToExtract=function(){return(this||I).minver};z.prototype.setComment=function(t){L.byteLength(t)!==t.length&&this.getGeneralPurposeBit().useUTF8ForNames(true);(this||I).comment=t};z.prototype.setCompressedSize=function(t){if(t<0)throw new Error("invalid entry compressed size");(this||I).csize=t};z.prototype.setCrc=function(t){if(t<0)throw new Error("invalid entry crc32");(this||I).crc=t};z.prototype.setExternalAttributes=function(t){(this||I).exattr=t>>>0};z.prototype.setExtra=function(t){(this||I).extra=t};z.prototype.setGeneralPurposeBit=function(t){if(!(t instanceof M))throw new Error("invalid entry GeneralPurposeBit");(this||I).gpb=t};z.prototype.setInternalAttributes=function(t){(this||I).inattr=t};z.prototype.setMethod=function(t){if(t<0)throw new Error("invalid entry compression method");(this||I).method=t};z.prototype.setName=function(t){t=A(t,false).replace(/^\w+:/,"").replace(/^(\.\.\/|\/)+/,"");L.byteLength(t)!==t.length&&this.getGeneralPurposeBit().useUTF8ForNames(true);(this||I).name=t};z.prototype.setPlatform=function(t){(this||I).platform=t};z.prototype.setSize=function(t){if(t<0)throw new Error("invalid entry size");(this||I).size=t};z.prototype.setTime=function(t,e){if(!(t instanceof Date))throw new Error("invalid entry time");(this||I).time=b.dateToDos(t,e)};z.prototype.setUnixMode=function(t){t|=this.isDirectory()?N.S_IFDIR:N.S_IFREG;var e=0;e|=t<<N.SHORT_SHIFT|(this.isDirectory()?N.S_DOS_D:N.S_DOS_A);this.setExternalAttributes(e);(this||I).mode=t&N.MODE_MASK;(this||I).platform=N.PLATFORM_UNIX};z.prototype.setVersionNeededToExtract=function(t){(this||I).minver=t};z.prototype.isDirectory=function(){return"/"===this.getName().slice(-1)};z.prototype.isUnixSymlink=function(){return(this.getUnixMode()&F.FILE_TYPE_FLAG)===F.LINK_FLAG};z.prototype.isZip64=function(){return(this||I).csize>N.ZIP64_MAGIC||(this||I).size>N.ZIP64_MAGIC};var P=B;var R={};var Z=r.Buffer;var G=o.Stream;var x=n.PassThrough;var H=R={};H.isStream=function(t){return t instanceof G};H.normalizeInputSource=function(t){if(null===t)return Z.alloc(0);if("string"===typeof t)return Z.from(t);if(H.isStream(t)&&!t._readableState){var e=new x;t.pipe(e);return e}return t};var U=R;var V="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var K={};var j=r.Buffer;var Y=t.inherits;var k=n.Transform;var X=c;var W=U;var q=K=function(t){if(!((this||V)instanceof q))return new q(t);k.call(this||V,t);(this||V).offset=0;(this||V)._archive={finish:false,finished:false,processing:false}};Y(q,k);q.prototype._appendBuffer=function(t,e,r){};q.prototype._appendStream=function(t,e,r){};q.prototype._emitErrorCallback=function(t){t&&this.emit("error",t)};q.prototype._finish=function(t){};q.prototype._normalizeEntry=function(t){};q.prototype._transform=function(t,e,r){r(null,t)};q.prototype.entry=function(t,e,r){e=e||null;"function"!==typeof r&&(r=(this||V)._emitErrorCallback.bind(this||V));if(t instanceof X)if((this||V)._archive.finish||(this||V)._archive.finished)r(new Error("unacceptable entry after finish"));else{if(!(this||V)._archive.processing){(this||V)._archive.processing=true;this._normalizeEntry(t);(this||V)._entry=t;e=W.normalizeInputSource(e);if(j.isBuffer(e))this._appendBuffer(t,e,r);else{if(!W.isStream(e)){(this||V)._archive.processing=false;r(new Error("input source must be valid Stream or Buffer instance"));return}this._appendStream(t,e,r)}return this||V}r(new Error("already processing an entry"))}else r(new Error("not a valid instance of ArchiveEntry"))};q.prototype.finish=function(){(this||V)._archive.processing?(this||V)._archive.finish=true:this._finish()};q.prototype.getBytesWritten=function(){return(this||V).offset};q.prototype.write=function(t,e){t&&((this||V).offset+=t.length);return k.prototype.write.call(this||V,t,e)};var J=K;var Q="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var $={};var tt=r.Buffer;var et=t.inherits;var rt=a;var{CRC32Stream:it}=h;var{DeflateCRC32Stream:st}=h;var nt=J;var ot=P;var at=w;var ht=s;var ft=U;var pt=i;var ct=$=function(t){if(!((this||Q)instanceof ct))return new ct(t);t=(this||Q).options=this._defaults(t);nt.call(this||Q,t);(this||Q)._entry=null;(this||Q)._entries=[];(this||Q)._archive={centralLength:0,centralOffset:0,comment:"",finish:false,finished:false,processing:false,forceZip64:t.forceZip64,forceLocalTime:t.forceLocalTime}};et(ct,nt);ct.prototype._afterAppend=function(t){(this||Q)._entries.push(t);t.getGeneralPurposeBit().usesDataDescriptor()&&this._writeDataDescriptor(t);(this||Q)._archive.processing=false;(this||Q)._entry=null;(this||Q)._archive.finish&&!(this||Q)._archive.finished&&this._finish()};ct.prototype._appendBuffer=function(t,e,r){0===e.length&&t.setMethod(ht.METHOD_STORED);var i=t.getMethod();if(i===ht.METHOD_STORED){t.setSize(e.length);t.setCompressedSize(e.length);t.setCrc(rt.unsigned(e))}this._writeLocalFileHeader(t);if(i!==ht.METHOD_STORED)i!==ht.METHOD_DEFLATED?r(new Error("compression method "+i+" not implemented")):this._smartStream(t,r).end(e);else{this.write(e);this._afterAppend(t);r(null,t)}};ct.prototype._appendStream=function(t,e,r){t.getGeneralPurposeBit().useDataDescriptor(true);t.setVersionNeededToExtract(ht.MIN_VERSION_DATA_DESCRIPTOR);this._writeLocalFileHeader(t);var i=this._smartStream(t,r);e.once("error",(function(t){i.emit("error",t);i.end()}));e.pipe(i)};ct.prototype._defaults=function(t){"object"!==typeof t&&(t={});"object"!==typeof t.zlib&&(t.zlib={});"number"!==typeof t.zlib.level&&(t.zlib.level=ht.ZLIB_BEST_SPEED);t.forceZip64=!!t.forceZip64;t.forceLocalTime=!!t.forceLocalTime;return t};ct.prototype._finish=function(){(this||Q)._archive.centralOffset=(this||Q).offset;(this||Q)._entries.forEach(function(t){this._writeCentralFileHeader(t)}.bind(this||Q));(this||Q)._archive.centralLength=(this||Q).offset-(this||Q)._archive.centralOffset;this.isZip64()&&this._writeCentralDirectoryZip64();this._writeCentralDirectoryEnd();(this||Q)._archive.processing=false;(this||Q)._archive.finish=true;(this||Q)._archive.finished=true;this.end()};ct.prototype._normalizeEntry=function(t){-1===t.getMethod()&&t.setMethod(ht.METHOD_DEFLATED);if(t.getMethod()===ht.METHOD_DEFLATED){t.getGeneralPurposeBit().useDataDescriptor(true);t.setVersionNeededToExtract(ht.MIN_VERSION_DATA_DESCRIPTOR)}-1===t.getTime()&&t.setTime(new Date,(this||Q)._archive.forceLocalTime);t._offsets={file:0,data:0,contents:0}};ct.prototype._smartStream=function(t,e){var r=t.getMethod()===ht.METHOD_DEFLATED;var i=r?new st((this||Q).options.zlib):new it;var s=null;function handleStuff(){var r=i.digest().readUInt32BE(0);t.setCrc(r);t.setSize(i.size());t.setCompressedSize(i.size(true));this._afterAppend(t);e(s,t)}i.once("end",handleStuff.bind(this||Q));i.once("error",(function(t){s=t}));i.pipe(this||Q,{end:false});return i};ct.prototype._writeCentralDirectoryEnd=function(){var t=(this||Q)._entries.length;var e=(this||Q)._archive.centralLength;var r=(this||Q)._archive.centralOffset;if(this.isZip64()){t=ht.ZIP64_MAGIC_SHORT;e=ht.ZIP64_MAGIC;r=ht.ZIP64_MAGIC}this.write(pt.getLongBytes(ht.SIG_EOCD));this.write(ht.SHORT_ZERO);this.write(ht.SHORT_ZERO);this.write(pt.getShortBytes(t));this.write(pt.getShortBytes(t));this.write(pt.getLongBytes(e));this.write(pt.getLongBytes(r));var i=this.getComment();var s=tt.byteLength(i);this.write(pt.getShortBytes(s));this.write(i)};ct.prototype._writeCentralDirectoryZip64=function(){this.write(pt.getLongBytes(ht.SIG_ZIP64_EOCD));this.write(pt.getEightBytes(44));this.write(pt.getShortBytes(ht.MIN_VERSION_ZIP64));this.write(pt.getShortBytes(ht.MIN_VERSION_ZIP64));this.write(ht.LONG_ZERO);this.write(ht.LONG_ZERO);this.write(pt.getEightBytes((this||Q)._entries.length));this.write(pt.getEightBytes((this||Q)._entries.length));this.write(pt.getEightBytes((this||Q)._archive.centralLength));this.write(pt.getEightBytes((this||Q)._archive.centralOffset));this.write(pt.getLongBytes(ht.SIG_ZIP64_EOCD_LOC));this.write(ht.LONG_ZERO);this.write(pt.getEightBytes((this||Q)._archive.centralOffset+(this||Q)._archive.centralLength));this.write(pt.getLongBytes(1))};ct.prototype._writeCentralFileHeader=function(t){var e=t.getGeneralPurposeBit();var r=t.getMethod();var i=t._offsets;var s=t.getSize();var n=t.getCompressedSize();if(t.isZip64()||i.file>ht.ZIP64_MAGIC){s=ht.ZIP64_MAGIC;n=ht.ZIP64_MAGIC;t.setVersionNeededToExtract(ht.MIN_VERSION_ZIP64);var o=tt.concat([pt.getShortBytes(ht.ZIP64_EXTRA_ID),pt.getShortBytes(24),pt.getEightBytes(t.getSize()),pt.getEightBytes(t.getCompressedSize()),pt.getEightBytes(i.file)],28);t.setExtra(o)}this.write(pt.getLongBytes(ht.SIG_CFH));this.write(pt.getShortBytes(t.getPlatform()<<8|ht.VERSION_MADEBY));this.write(pt.getShortBytes(t.getVersionNeededToExtract()));this.write(e.encode());this.write(pt.getShortBytes(r));this.write(pt.getLongBytes(t.getTimeDos()));this.write(pt.getLongBytes(t.getCrc()));this.write(pt.getLongBytes(n));this.write(pt.getLongBytes(s));var a=t.getName();var h=t.getComment();var f=t.getCentralDirectoryExtra();if(e.usesUTF8ForNames()){a=tt.from(a);h=tt.from(h)}this.write(pt.getShortBytes(a.length));this.write(pt.getShortBytes(f.length));this.write(pt.getShortBytes(h.length));this.write(ht.SHORT_ZERO);this.write(pt.getShortBytes(t.getInternalAttributes()));this.write(pt.getLongBytes(t.getExternalAttributes()));i.file>ht.ZIP64_MAGIC?this.write(pt.getLongBytes(ht.ZIP64_MAGIC)):this.write(pt.getLongBytes(i.file));this.write(a);this.write(f);this.write(h)};ct.prototype._writeDataDescriptor=function(t){this.write(pt.getLongBytes(ht.SIG_DD));this.write(pt.getLongBytes(t.getCrc()));if(t.isZip64()){this.write(pt.getEightBytes(t.getCompressedSize()));this.write(pt.getEightBytes(t.getSize()))}else{this.write(pt.getLongBytes(t.getCompressedSize()));this.write(pt.getLongBytes(t.getSize()))}};ct.prototype._writeLocalFileHeader=function(t){var e=t.getGeneralPurposeBit();var r=t.getMethod();var i=t.getName();var s=t.getLocalFileDataExtra();if(t.isZip64()){e.useDataDescriptor(true);t.setVersionNeededToExtract(ht.MIN_VERSION_ZIP64)}e.usesUTF8ForNames()&&(i=tt.from(i));t._offsets.file=(this||Q).offset;this.write(pt.getLongBytes(ht.SIG_LFH));this.write(pt.getShortBytes(t.getVersionNeededToExtract()));this.write(e.encode());this.write(pt.getShortBytes(r));this.write(pt.getLongBytes(t.getTimeDos()));t._offsets.data=(this||Q).offset;if(e.usesDataDescriptor()){this.write(ht.LONG_ZERO);this.write(ht.LONG_ZERO);this.write(ht.LONG_ZERO)}else{this.write(pt.getLongBytes(t.getCrc()));this.write(pt.getLongBytes(t.getCompressedSize()));this.write(pt.getLongBytes(t.getSize()))}this.write(pt.getShortBytes(i.length));this.write(pt.getShortBytes(s.length));this.write(i);this.write(s);t._offsets.contents=(this||Q).offset};ct.prototype.getComment=function(t){return null!==(this||Q)._archive.comment?(this||Q)._archive.comment:""};ct.prototype.isZip64=function(){return(this||Q)._archive.forceZip64||(this||Q)._entries.length>ht.ZIP64_MAGIC_SHORT||(this||Q)._archive.centralLength>ht.ZIP64_MAGIC||(this||Q)._archive.centralOffset>ht.ZIP64_MAGIC};ct.prototype.setComment=function(t){(this||Q)._archive.comment=t};var ut=$;var lt={};lt={ArchiveEntry:c,ZipArchiveEntry:P,ArchiveOutputStream:J,ZipArchiveOutputStream:ut};var gt=lt;const yt=lt.ArchiveEntry;export default gt;export{yt as ArchiveEntry};

