import e from"accepts";import r from"safe-buffer";import n from"bytes";import t from"compressible";import o from"debug";import s from"on-headers";import i from"vary";import a from"zlib";var f={};var c=e;var u=r.Buffer;var d=n;var l=t;var m=o("compression");var p=s;var h=i;var v=a;f=compression;f.filter=shouldCompress;var g=/(?:^|,)\s*?no-transform\s*?(?:,|$)/;function compression(e){var r=e||{};var n=r.filter||shouldCompress;var t=d.parse(r.threshold);null==t&&(t=1024);return function compression(e,o,s){var i=false;var a;var f=[];var u;var d=o.end;var l=o.on;var g=o.write;o.flush=function flush(){u&&u.flush()};o.write=function write(e,r){if(i)return false;this._header||this._implicitHeader();return u?u.write(toBuffer(e,r)):g.call(this,e,r)};o.end=function end(e,r){if(i)return false;if(!this._header){this.getHeader("Content-Length")||(a=chunkLength(e,r));this._implicitHeader()}if(!u)return d.call(this,e,r);i=true;return e?u.end(toBuffer(e,r)):u.end()};o.on=function on(e,r){if(!f||"drain"!==e)return l.call(this,e,r);if(u)return u.on(e,r);f.push([e,r]);return this};function nocompress(e){m("no compression: %s",e);addListeners(o,l,f);f=null}p(o,(function onResponseHeaders(){if(n(e,o))if(shouldTransform(e,o)){h(o,"Accept-Encoding");if(Number(o.getHeader("Content-Length"))<t||a<t)nocompress("size below threshold");else{var s=o.getHeader("Content-Encoding")||"identity";if("identity"===s)if("HEAD"!==e.method){var i=c(e);var p=i.encoding(["gzip","deflate","identity"]);"deflate"===p&&i.encoding(["gzip"])&&(p=i.encoding(["gzip","identity"]));if(p&&"identity"!==p){m("%s compression",p);u="gzip"===p?v.createGzip(r):v.createDeflate(r);addListeners(u,u.on,f);o.setHeader("Content-Encoding",p);o.removeHeader("Content-Length");u.on("data",(function onStreamData(e){false===g.call(o,e)&&u.pause()}));u.on("end",(function onStreamEnd(){d.call(o)}));l.call(o,"drain",(function onResponseDrain(){u.resume()}))}else nocompress("not acceptable")}else nocompress("HEAD request");else nocompress("already encoded")}}else nocompress("no transform");else nocompress("filtered")}));s()}}function addListeners(e,r,n){for(var t=0;t<n.length;t++)r.apply(e,n[t])}function chunkLength(e,r){return e?u.isBuffer(e)?e.length:u.byteLength(e,r):0}function shouldCompress(e,r){var n=r.getHeader("Content-Type");if(void 0===n||!l(n)){m("%s not compressible",n);return false}return true}function shouldTransform(e,r){var n=r.getHeader("Cache-Control");return!n||!g.test(n)}function toBuffer(e,r){return u.isBuffer(e)?e:u.from(e,r)}var H=f;const y=f.filter;export default H;export{y as filter};

