import"./has.js";import n from"./def.js";import e from"./promise.js";import t from"./flatten.js";var r={};var o=e,u=t,i=n,noop=function(){};r=function emitterify(n,e){n=n||{};e=e||{};i(n,"emit",emit,1);i(n,"once",once,1);i(n,"off",off,1);i(n,"on",on,1);n.on["*"]=n.on["*"]||[];return n;function emit(e,t,r){var o=n.on[e.split(".")[0]]||[],i=[];for(var f=0;f<o.length;f++)o[f].ns&&r&&!r(o[f].ns)||i.push(call(o[f].isOnce?o.splice(f--,1)[0]:o[f],t));for(var f=0;f<n.on["*"].length;f++)i.push(call(n.on["*"][f],[e,t]));return i.reduce(u,[])}function call(e,t){return e.next?e.next(t):t instanceof Array?e.apply(n,t):e.call(n,t)}function on(t,r,o){var u=t.split(".")[0],i=t.split(".")[1],f=n.on[u]=n.on[u]||[],c="function"==typeof r?r:0;return!c&&i?(c=n.on[u]["$"+i])?c:push(observable(n,r)):c||i?c&&i?push((remove(f,n.on[u]["$"+i]||-1),c)):!(!c||i)&&push(c):push(observable(n,r));function push(t){t.isOnce=o;t.type=u;i&&(n.on[u]["$"+(t.ns=i)]=t);f.push(t);(e.on||noop)(t);return t.next?t:n}}function once(e,t){return n.on(e,t,true)}function remove(n,t){var r=n.length;while(~--r)t!=n[r]&&t!=n[r].fn&&t||(e.off||noop)(n.splice(r,1)[0])}function off(e,t){remove(n.on[e]||[],t);t&&t.ns&&delete n.on[e]["$"+t.ns];return n}function observable(n,e){e=e||{};var t=emitterify(e.base||o());t.i=0;t.li=[];t.fn=e.fn;t.parent=n;t.source=e.fn?t.parent.source:t;t.on("stop",(function(n){t.type?t.parent.off(t.type,t):t.parent.off(t);return t.reason=n}));t.each=function(n){var e=n.next?n:observable(t,{fn:n});t.li.push(e);return e};t.pipe=function(n){return n(t)};t.map=function(n){return t.each((function(e,t,r){return r.next(n(e,t,r))}))};t.filter=function(n){return t.each((function(e,t,r){return n(e,t,r)&&r.next(e)}))};t.reduce=function(n,e){return t.each((function(t,r,o){return o.next(e=n(e,t,r,o))}))};t.unpromise=function(){var n=observable(t,{base:{},fn:function(e){return n.next(e)}});t.li.push(n);return n};t.next=function(n){t.resolve&&t.resolve(n);return t.li.length?t.li.map((function(e){return e.fn(n,e.i++,e)})):n};t.until=function(n){return n?n.each?n.each(t.stop):n.then?n.then(t.stop):n.call?t.filter(n).map(t.stop):0:0};t.off=function(n){return remove(t.li,n),t};t.start=function(n){t.until(n);t.source.emit("start");return t};t.stop=function(n){return t.source.emit("stop",n)};t[Symbol.asyncIterator]=function(){return{next:function(){return t.wait=new Promise((function(n){t.wait=true;t.map((function(e,r,o){delete t.wait;t.off(o);n({value:e,done:false})}));t.emit("pull",t)}))}}};return t}};var f=r;export default f;

