import t from"fs";import e from"glob";import i from"async";import r from"path";import s from"archiver-utils";import n from"util";import o from"readable-stream";import a from"process";import u from"buffer";import"zip-stream";import f from"./lib/plugins/zip.js";import h from"zlib";import p from"tar-stream";import l from"buffer-crc32";var d="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var m={};
/**
 * Archiver Core
 *
 * @ignore
 * @license [MIT]{@link https://github.com/archiverjs/node-archiver/blob/master/LICENSE}
 * @copyright (c) 2012-2014 Chris Talkington, contributors.
 */var c=n;const y={ABORTED:"archive was aborted",DIRECTORYDIRPATHREQUIRED:"diretory dirpath argument must be a non-empty string value",DIRECTORYFUNCTIONINVALIDDATA:"invalid data returned by directory custom data function",ENTRYNAMEREQUIRED:"entry name must be a non-empty string value",FILEFILEPATHREQUIRED:"file filepath argument must be a non-empty string value",FINALIZING:"archive already finalizing",QUEUECLOSED:"queue closed",NOENDMETHOD:"no suitable finalize/end method defined by module",DIRECTORYNOTSUPPORTED:"support for directory entries not defined by module",FORMATSET:"archive format already set",INPUTSTEAMBUFFERREQUIRED:"input source must be valid Stream or Buffer instance",MODULESET:"module already set",SYMLINKNOTSUPPORTED:"support for symlink entries not defined by module",SYMLINKFILEPATHREQUIRED:"symlink filepath argument must be a non-empty string value",SYMLINKTARGETREQUIRED:"symlink target argument must be a non-empty string value",ENTRYNOTSUPPORTED:"entry not supported"};function ArchiverError(t,e){Error.captureStackTrace(this||d,(this||d).constructor);(this||d).message=y[t]||t;(this||d).code=t;(this||d).data=e}c.inherits(ArchiverError,Error);m=m=ArchiverError;var _=m;var E="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var g={};var b=u.Buffer;var T=a;
/**
 * Archiver Core
 *
 * @ignore
 * @license [MIT]{@link https://github.com/archiverjs/node-archiver/blob/master/LICENSE}
 * @copyright (c) 2012-2014 Chris Talkington, contributors.
 */var v=t;var z=e;var R=i;var D=r;var S=s;var w=n.inherits;var I=_;var O=o.Transform;var P="win32"===T.platform;var Archiver=function(t,e){if(!((this||E)instanceof Archiver))return new Archiver(t,e);if("string"!==typeof t){e=t;t="zip"}e=(this||E).options=S.defaults(e,{highWaterMark:1024*1024,statConcurrency:4});O.call(this||E,e);(this||E)._format=false;(this||E)._module=false;(this||E)._pending=0;(this||E)._pointer=0;(this||E)._entriesCount=0;(this||E)._entriesProcessedCount=0;(this||E)._fsEntriesTotalBytes=0;(this||E)._fsEntriesProcessedBytes=0;(this||E)._queue=R.queue((this||E)._onQueueTask.bind(this||E),1);(this||E)._queue.drain=(this||E)._onQueueDrain.bind(this||E);(this||E)._statQueue=R.queue((this||E)._onStatQueueTask.bind(this||E),e.statConcurrency);(this||E)._state={aborted:false,finalize:false,finalizing:false,finalized:false,modulePiped:false};(this||E)._streams=[]};w(Archiver,O);Archiver.prototype._abort=function(){(this||E)._state.aborted=true;(this||E)._queue.kill();(this||E)._statQueue.kill();(this||E)._queue.idle()&&this._shutdown()};Archiver.prototype._append=function(t,e){e=e||{};var i={source:null,filepath:t};e.name||(e.name=t);e.sourcePath=t;i.data=e;(this||E)._entriesCount++;if(e.stats&&e.stats instanceof v.Stats){i=this._updateQueueTaskWithStats(i,e.stats);if(i){e.stats.size&&((this||E)._fsEntriesTotalBytes+=e.stats.size);(this||E)._queue.push(i)}}else(this||E)._statQueue.push(i)};Archiver.prototype._finalize=function(){if(!((this||E)._state.finalizing||(this||E)._state.finalized||(this||E)._state.aborted)){(this||E)._state.finalizing=true;this._moduleFinalize();(this||E)._state.finalizing=false;(this||E)._state.finalized=true}};Archiver.prototype._maybeFinalize=function(){if((this||E)._state.finalizing||(this||E)._state.finalized||(this||E)._state.aborted)return false;if((this||E)._state.finalize&&0===(this||E)._pending&&(this||E)._queue.idle()&&(this||E)._statQueue.idle()){this._finalize();return true}return false};Archiver.prototype._moduleAppend=function(t,e,i){(this||E)._state.aborted?i():(this||E)._module.append(t,e,function(t){(this||E)._task=null;if((this||E)._state.aborted)this._shutdown();else if(t){this.emit("error",t);T.nextTick(i)}else{this.emit("entry",e);(this||E)._entriesProcessedCount++;e.stats&&e.stats.size&&((this||E)._fsEntriesProcessedBytes+=e.stats.size);this.emit("progress",{entries:{total:(this||E)._entriesCount,processed:(this||E)._entriesProcessedCount},fs:{totalBytes:(this||E)._fsEntriesTotalBytes,processedBytes:(this||E)._fsEntriesProcessedBytes}});T.nextTick(i)}}.bind(this||E))};Archiver.prototype._moduleFinalize=function(){"function"===typeof(this||E)._module.finalize?(this||E)._module.finalize():"function"===typeof(this||E)._module.end?(this||E)._module.end():this.emit("error",new I("NOENDMETHOD"))};Archiver.prototype._modulePipe=function(){(this||E)._module.on("error",(this||E)._onModuleError.bind(this||E));(this||E)._module.pipe(this||E);(this||E)._state.modulePiped=true};Archiver.prototype._moduleSupports=function(t){return!(!(this||E)._module.supports||!(this||E)._module.supports[t])&&(this||E)._module.supports[t]};Archiver.prototype._moduleUnpipe=function(){(this||E)._module.unpipe(this||E);(this||E)._state.modulePiped=false};Archiver.prototype._normalizeEntryData=function(t,e){t=S.defaults(t,{type:"file",name:null,date:null,mode:null,prefix:null,sourcePath:null,stats:false});e&&false===t.stats&&(t.stats=e);var i="directory"===t.type;if(t.name){if("string"===typeof t.prefix&&""!==t.prefix){t.name=t.prefix+"/"+t.name;t.prefix=null}t.name=S.sanitizePath(t.name);if("symlink"!==t.type&&"/"===t.name.slice(-1)){i=true;t.type="directory"}else i&&(t.name+="/")}if("number"===typeof t.mode)t.mode&=P?511:4095;else if(t.stats&&null===t.mode){t.mode=P?511&t.stats.mode:4095&t.stats.mode;P&&i&&(t.mode=493)}else null===t.mode&&(t.mode=i?493:420);t.stats&&null===t.date?t.date=t.stats.mtime:t.date=S.dateify(t.date);return t};Archiver.prototype._onModuleError=function(t){this.emit("error",t)};Archiver.prototype._onQueueDrain=function(){(this||E)._state.finalizing||(this||E)._state.finalized||(this||E)._state.aborted||(this||E)._state.finalize&&0===(this||E)._pending&&(this||E)._queue.idle()&&(this||E)._statQueue.idle()&&this._finalize()};Archiver.prototype._onQueueTask=function(t,e){if((this||E)._state.finalizing||(this||E)._state.finalized||(this||E)._state.aborted)e();else{(this||E)._task=t;this._moduleAppend(t.source,t.data,e)}};Archiver.prototype._onStatQueueTask=function(t,e){(this||E)._state.finalizing||(this||E)._state.finalized||(this||E)._state.aborted?e():v.lstat(t.filepath,function(i,r){if((this||E)._state.aborted)T.nextTick(e);else if(i){(this||E)._entriesCount--;this.emit("warning",i);T.nextTick(e)}else{t=this._updateQueueTaskWithStats(t,r);if(t){r.size&&((this||E)._fsEntriesTotalBytes+=r.size);(this||E)._queue.push(t)}T.nextTick(e)}}.bind(this||E))};Archiver.prototype._shutdown=function(){this._moduleUnpipe();this.end()};Archiver.prototype._transform=function(t,e,i){t&&((this||E)._pointer+=t.length);i(null,t)};Archiver.prototype._updateQueueTaskWithStats=function(t,e){if(e.isFile()){t.data.type="file";t.data.sourceType="stream";t.source=S.lazyReadStream(t.filepath)}else if(e.isDirectory()&&this._moduleSupports("directory")){t.data.name=S.trailingSlashIt(t.data.name);t.data.type="directory";t.data.sourcePath=S.trailingSlashIt(t.filepath);t.data.sourceType="buffer";t.source=b.concat([])}else{if(!e.isSymbolicLink()||!this._moduleSupports("symlink")){e.isDirectory()?this.emit("warning",new I("DIRECTORYNOTSUPPORTED",t.data)):e.isSymbolicLink()?this.emit("warning",new I("SYMLINKNOTSUPPORTED",t.data)):this.emit("warning",new I("ENTRYNOTSUPPORTED",t.data));return null}var i=v.readlinkSync(t.filepath);var r=D.dirname(t.filepath);t.data.type="symlink";t.data.linkname=D.relative(r,D.resolve(r,i));t.data.sourceType="buffer";t.source=b.concat([])}t.data=this._normalizeEntryData(t.data,e);return t};Archiver.prototype.abort=function(){if((this||E)._state.aborted||(this||E)._state.finalized)return this||E;this._abort();return this||E};Archiver.prototype.append=function(t,e){if((this||E)._state.finalize||(this||E)._state.aborted){this.emit("error",new I("QUEUECLOSED"));return this||E}e=this._normalizeEntryData(e);if("string"!==typeof e.name||0===e.name.length){this.emit("error",new I("ENTRYNAMEREQUIRED"));return this||E}if("directory"===e.type&&!this._moduleSupports("directory")){this.emit("error",new I("DIRECTORYNOTSUPPORTED",{name:e.name}));return this||E}t=S.normalizeInputSource(t);if(b.isBuffer(t))e.sourceType="buffer";else{if(!S.isStream(t)){this.emit("error",new I("INPUTSTEAMBUFFERREQUIRED",{name:e.name}));return this||E}e.sourceType="stream"}(this||E)._entriesCount++;(this||E)._queue.push({data:e,source:t});return this||E};Archiver.prototype.directory=function(t,e,i){if((this||E)._state.finalize||(this||E)._state.aborted){this.emit("error",new I("QUEUECLOSED"));return this||E}if("string"!==typeof t||0===t.length){this.emit("error",new I("DIRECTORYDIRPATHREQUIRED"));return this||E}(this||E)._pending++;false===e?e="":"string"!==typeof e&&(e=t);var r=false;if("function"===typeof i){r=i;i={}}else"object"!==typeof i&&(i={});var s={stat:false,dot:true,cwd:t};function onGlobEnd(){(this||E)._pending--;this._maybeFinalize()}function onGlobError(t){this.emit("error",t)}function onGlobMatch(s){var o=false;var a=Object.assign({},i);a.name=s;a.prefix=e;s=n._makeAbs(s);try{if(r){a=r(a);if(false===a)o=true;else if("object"!==typeof a)throw new I("DIRECTORYFUNCTIONINVALIDDATA",{dirpath:t})}}catch(t){this.emit("error",t);return}o||this._append(s,a)}var n=z("**",s);n.on("error",onGlobError.bind(this||E));n.on("match",onGlobMatch.bind(this||E));n.on("end",onGlobEnd.bind(this||E));return this||E};Archiver.prototype.file=function(t,e){if((this||E)._state.finalize||(this||E)._state.aborted){this.emit("error",new I("QUEUECLOSED"));return this||E}if("string"!==typeof t||0===t.length){this.emit("error",new I("FILEFILEPATHREQUIRED"));return this||E}this._append(t,e);return this||E};Archiver.prototype.glob=function(t,e,i){(this||E)._pending++;e=S.defaults(e,{stat:false});function onGlobEnd(){(this||E)._pending--;this._maybeFinalize()}function onGlobError(t){this.emit("error",t)}function onGlobMatch(t){var s=Object.assign({},i);if(e.cwd){s.name=t;t=r._makeAbs(t)}this._append(t,s)}var r=z(t,e);r.on("error",onGlobError.bind(this||E));r.on("match",onGlobMatch.bind(this||E));r.on("end",onGlobEnd.bind(this||E));return this||E};Archiver.prototype.finalize=function(){if((this||E)._state.aborted){this.emit("error",new I("ABORTED"));return this||E}if((this||E)._state.finalize){this.emit("error",new I("FINALIZING"));return this||E}(this||E)._state.finalize=true;0===(this||E)._pending&&(this||E)._queue.idle()&&(this||E)._statQueue.idle()&&this._finalize();var t=this||E;return new Promise((function(e,i){var r;t._module.on("end",(function(){r||e()}));t._module.on("error",(function(t){r=true;i(t)}))}))};Archiver.prototype.setFormat=function(t){if((this||E)._format){this.emit("error",new I("FORMATSET"));return this||E}(this||E)._format=t;return this||E};Archiver.prototype.setModule=function(t){if((this||E)._state.aborted){this.emit("error",new I("ABORTED"));return this||E}if((this||E)._state.module){this.emit("error",new I("MODULESET"));return this||E}(this||E)._module=t;this._modulePipe();return this||E};Archiver.prototype.symlink=function(t,e){if((this||E)._state.finalize||(this||E)._state.aborted){this.emit("error",new I("QUEUECLOSED"));return this||E}if("string"!==typeof t||0===t.length){this.emit("error",new I("SYMLINKFILEPATHREQUIRED"));return this||E}if("string"!==typeof e||0===e.length){this.emit("error",new I("SYMLINKTARGETREQUIRED",{filepath:t}));return this||E}if(!this._moduleSupports("symlink")){this.emit("error",new I("SYMLINKNOTSUPPORTED",{filepath:t}));return this||E}var i={};i.type="symlink";i.name=t.replace(/\\/g,"/");i.linkname=e.replace(/\\/g,"/");i.sourceType="buffer";(this||E)._entriesCount++;(this||E)._queue.push({data:i,source:b.concat([])});return this||E};Archiver.prototype.pointer=function(){return(this||E)._pointer};Archiver.prototype.use=function(t){(this||E)._streams.push(t);return this||E};g=Archiver;var U=g;var N="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var k={};
/**
 * TAR Format Plugin
 *
 * @module plugins/tar
 * @license [MIT]{@link https://github.com/archiverjs/node-archiver/blob/master/LICENSE}
 * @copyright (c) 2012-2014 Chris Talkington, contributors.
 */var A=h;var Q=p;var F=s;var Tar=function(t){if(!((this||N)instanceof Tar))return new Tar(t);t=(this||N).options=F.defaults(t,{gzip:false});"object"!==typeof t.gzipOptions&&(t.gzipOptions={});(this||N).supports={directory:true,symlink:true};(this||N).engine=Q.pack(t);(this||N).compressor=false;if(t.gzip){(this||N).compressor=A.createGzip(t.gzipOptions);(this||N).compressor.on("error",(this||N)._onCompressorError.bind(this||N))}};Tar.prototype._onCompressorError=function(t){(this||N).engine.emit("error",t)};Tar.prototype.append=function(t,e,i){var r=this||N;e.mtime=e.date;function append(t,s){t?i(t):r.engine.entry(e,s,(function(t){i(t,e)}))}if("buffer"===e.sourceType)append(null,t);else if("stream"===e.sourceType&&e.stats){e.size=e.stats.size;var s=r.engine.entry(e,(function(t){i(t,e)}));t.pipe(s)}else"stream"===e.sourceType&&F.collectStream(t,append)};Tar.prototype.finalize=function(){(this||N).engine.finalize()};Tar.prototype.on=function(){return(this||N).engine.on.apply((this||N).engine,arguments)};Tar.prototype.pipe=function(t,e){return(this||N).compressor?(this||N).engine.pipe.apply((this||N).engine,[(this||N).compressor]).pipe(t,e):(this||N).engine.pipe.apply((this||N).engine,arguments)};Tar.prototype.unpipe=function(){return(this||N).compressor?(this||N).compressor.unpipe.apply((this||N).compressor,arguments):(this||N).engine.unpipe.apply((this||N).engine,arguments)};k=Tar;var C=k;var L="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var M={};
/**
 * JSON Format Plugin
 *
 * @module plugins/json
 * @license [MIT]{@link https://github.com/archiverjs/node-archiver/blob/master/LICENSE}
 * @copyright (c) 2012-2014 Chris Talkington, contributors.
 */var Y=n.inherits;var B=o.Transform;var G=l;var q=s;var Json=function(t){if(!((this||L)instanceof Json))return new Json(t);t=(this||L).options=q.defaults(t,{});B.call(this||L,t);(this||L).supports={directory:true,symlink:true};(this||L).files=[]};Y(Json,B);Json.prototype._transform=function(t,e,i){i(null,t)};Json.prototype._writeStringified=function(){var t=JSON.stringify((this||L).files);this.write(t)};Json.prototype.append=function(t,e,i){var r=this||L;e.crc32=0;function onend(t,s){if(t)i(t);else{e.size=s.length||0;e.crc32=G.unsigned(s);r.files.push(e);i(null,e)}}"buffer"===e.sourceType?onend(null,t):"stream"===e.sourceType&&q.collectStream(t,onend)};Json.prototype.finalize=function(){this._writeStringified();this.end()};M=Json;var x=M;var H={};
/**
 * Archiver Vending
 *
 * @ignore
 * @license [MIT]{@link https://github.com/archiverjs/node-archiver/blob/master/LICENSE}
 * @copyright (c) 2012-2014 Chris Talkington, contributors.
 */var j=U;var K={};var vending=function(t,e){return vending.create(t,e)};vending.create=function(t,e){if(K[t]){var i=new j(t,e);i.setFormat(t);i.setModule(new K[t](e));return i}throw new Error("create("+t+"): format not registered")};vending.registerFormat=function(t,e){if(K[t])throw new Error("register("+t+"): format already registered");if("function"!==typeof e)throw new Error("register("+t+"): format module invalid");if("function"!==typeof e.prototype.append||"function"!==typeof e.prototype.finalize)throw new Error("register("+t+"): format module missing methods");K[t]=e};vending.registerFormat("zip",f);vending.registerFormat("tar",C);vending.registerFormat("json",x);H=vending;var W=H;export default W;

