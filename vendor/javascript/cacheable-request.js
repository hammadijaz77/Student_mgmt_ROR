import*as e from"events";import*as t from"url";import*as a from"normalize-url";import*as r from"get-stream";import*as s from"http-cache-semantics";import*as o from"responselike";import*as c from"lowercase-keys";import*as n from"clone-response";import*as i from"keyv";var l="default"in e?e.default:e;var h="default"in t?t.default:t;var u="default"in a?a.default:a;var f="default"in r?r.default:r;var m="default"in s?s.default:s;var d="default"in o?o.default:o;var p="default"in c?c.default:c;var y="default"in n?n.default:n;var b="default"in i?i.default:i;var C={};const v=l;const w=h;const R=u;const q=f;const P=m;const E=d;const O=p;const g=y;const j=b;class CacheableRequest{constructor(e,t){if("function"!==typeof e)throw new TypeError("Parameter `request` must be a function");this.cache=new j({uri:"string"===typeof t&&t,store:"string"!==typeof t&&t,namespace:"cacheable-request"});return this.createCacheableRequest(e)}createCacheableRequest(e){return(t,a)=>{let r;if("string"===typeof t){r=normalizeUrlObject(w.parse(t));t={}}else if(t instanceof w.URL){r=normalizeUrlObject(w.parse(t.toString()));t={}}else{const[e,...a]=(t.path||"").split("?");const s=a.length>0?`?${a.join("?")}`:"";r=normalizeUrlObject({...t,pathname:e,search:s})}t={headers:{},method:"GET",cache:true,strictTtl:false,automaticFailover:false,...t,...urlObjectToRequestOptions(r)};t.headers=O(t.headers);const s=new v;const o=R(w.format(r),{stripWWW:false,removeTrailingSlash:false,stripAuthentication:false});const c=`${t.method}:${o}`;let n=false;let i=false;const makeRequest=t=>{i=true;let r=false;let o;const l=new Promise((e=>{o=()=>{if(!r){r=true;e()}}}));const handler=e=>{if(n&&!t.forceRefresh){e.status=e.statusCode;const a=P.fromObject(n.cachePolicy).revalidatedPolicy(t,e);if(!a.modified){const t=a.policy.responseHeaders();e=new E(n.statusCode,t,n.body,n.url);e.cachePolicy=a.policy;e.fromCache=true}}if(!e.fromCache){e.cachePolicy=new P(t,e,t);e.fromCache=false}let o;if(t.cache&&e.cachePolicy.storable()){o=g(e);(async()=>{try{const a=q.buffer(e);await Promise.race([l,new Promise((t=>e.once("end",t)))]);if(r)return;const s=await a;const o={cachePolicy:e.cachePolicy.toObject(),url:e.url,statusCode:e.fromCache?n.statusCode:e.statusCode,body:s};let i=t.strictTtl?e.cachePolicy.timeToLive():void 0;t.maxTtl&&(i=i?Math.min(i,t.maxTtl):t.maxTtl);await this.cache.set(c,o,i)}catch(e){s.emit("error",new CacheableRequest.CacheError(e))}})()}else t.cache&&n&&(async()=>{try{await this.cache.delete(c)}catch(e){s.emit("error",new CacheableRequest.CacheError(e))}})();s.emit("response",o||e);"function"===typeof a&&a(o||e)};try{const a=e(t,handler);a.once("error",o);a.once("abort",o);s.emit("request",a)}catch(e){s.emit("error",new CacheableRequest.RequestError(e))}};(async()=>{const get=async e=>{await Promise.resolve();const t=e.cache?await this.cache.get(c):void 0;if("undefined"===typeof t)return makeRequest(e);const r=P.fromObject(t.cachePolicy);if(r.satisfiesWithoutRevalidation(e)&&!e.forceRefresh){const e=r.responseHeaders();const o=new E(t.statusCode,e,t.body,t.url);o.cachePolicy=r;o.fromCache=true;s.emit("response",o);"function"===typeof a&&a(o)}else{n=t;e.headers=r.revalidationHeaders(e);makeRequest(e)}};const errorHandler=e=>s.emit("error",new CacheableRequest.CacheError(e));this.cache.once("error",errorHandler);s.on("response",(()=>this.cache.removeListener("error",errorHandler)));try{await get(t)}catch(e){t.automaticFailover&&!i&&makeRequest(t);s.emit("error",new CacheableRequest.CacheError(e))}})();return s}}}function urlObjectToRequestOptions(e){const t={...e};t.path=`${e.pathname||"/"}${e.search||""}`;delete t.pathname;delete t.search;return t}function normalizeUrlObject(e){return{protocol:e.protocol,auth:e.auth,hostname:e.hostname||e.host||"localhost",port:e.port,pathname:e.pathname,search:e.search}}CacheableRequest.RequestError=class extends Error{constructor(e){super(e.message);this.name="RequestError";Object.assign(this,e)}};CacheableRequest.CacheError=class extends Error{constructor(e){super(e.message);this.name="CacheError";Object.assign(this,e)}};C=CacheableRequest;var T=C;export{T as default};

