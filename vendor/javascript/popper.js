import e from"browser-icons";import r from"ngrok";import o from"utilise/pure";import s from"fs";import t from"child_process";import n from"cryonic";import a from"path";import i from"compression";import m from"browserify";import l from"platform";import p from"chokidar";import d from"express";import c from"rijs.resdir";import u from"serve-static";import f from"utilise/err";import _ from"process";import v from"utilise/log";import w from"wd";import h from"rijs.npm";import b from"rijs";var g={ie9:{browserName:"internet explorer",version:"9",platform:"WINDOWS",_name:"ie",_version:"9",_os:"windows"},ie11:{browserName:"internet explorer",version:"11",platform:"WINDOWS",_name:"ie",_version:"11",_os:"windows"},edge:{browserName:"edge",platform:"WINDOWS",_name:"ie",_os:"windows"},firefox:{browserName:"firefox",platform:"WINDOWS",_name:"firefox",_os:"windows"},chrome:{browserName:"chrome",platform:"WINDOWS",_name:"chrome",_os:"windows"},android:{browserName:"android",device:"Google Nexus 5",platform:"ANDROID",_name:"android",_os:"nexus",_os_version:"5"},iphone:{browserName:"iPhone",device:"iPhone 5",platform:"MAC",_name:"safari",_os:"iphone",_os_version:"5"},opera:{browserName:"opera",platform:"WINDOWS",_name:"opera",_os:"windows"},safari:{browserName:"safari",platform:"MAC",_name:"safari",_os:"osx"}};var N={};var x=_;const S=g,y=f("[popper][browserstack]");N={browsers:S,connect:connect};function connect(e){const r=x.env,o=r.BROWSERSTACK_KEY,s=r.BROWSERSTACK_USERNAME,t="hub.browserstack.com";return s&&o?e.remote(t,80,s,o):(y("Please provide your BrowserStack Credentials"),false)}var E=N;var O={ie9:{browserName:"internet explorer",version:"9.0",platform:"Windows 7",_name:"ie",_version:"9",_os:"windows"},ie11:{browserName:"internet explorer",version:"11.0",platform:"Windows 7",_name:"ie",_version:"11",_os:"windows"},edge:{browserName:"MicrosoftEdge",platform:"Windows 10",_name:"ie",_os:"windows"},firefox:{browserName:"firefox",platform:"WINDOWS",_name:"firefox",_os:"windows"},chrome:{browserName:"chrome",platform:"WINDOWS",_name:"chrome",_os:"windows"},android:{browserName:"android",device:"Google Nexus 5",platform:"ANDROID",_name:"android",_os:"nexus",_os_version:"5"},iphone:{browserName:"iPhone",device:"iPhone 5",platform:"MAC",_name:"safari",_os:"iphone",_os_version:"5"},opera:{browserName:"opera",platform:"WINDOWS",_name:"opera",_os:"windows"},safari:{browserName:"safari",platform:"MAC",_name:"safari",_os:"osx"}};var W={};var R=_;const{extend:I,str:A}=o,C=O,D=f("[popper][saucelabs]"),U=v("[popper][saucelabs]");W={browsers:C,connect:connect$1,status:status,parse:parse};function connect$1(e){const r=R.env,o=r.SAUCE_ACCESS_KEY,s=r.SAUCE_USERNAME,t="ondemand.saucelabs.com";return s&&o?e.remote(t,80,s,o):(D("Please provide your SauceLabs Credentials"),false)}function status(e,r){e.vm.sauceJobStatus(e.passed,o=>{o?D(o):U("status updated",r.uid.bold,A(e.passed)[e.passed?"green":"red"],A(e.build).grey);e.vm.quit()})}function parse(e){return I(e)({"tunnel-identifier":R.env.TRAVIS_JOB_NUMBER,build:R.env.TRAVIS_BUILD_NUMBER||~~(1e8*Math.random()),username:R.env.SAUCE_USERNAME,accessKey:R.env.SAUCE_ACCESS_KEY})}var k=W;var j={};j={browserstack:E,saucelabs:k};var M=j;var P={};function _nullRequire(e){var r=new Error("Cannot find module '"+e+"'");r.code="MODULE_NOT_FOUND";throw r}_nullRequire.resolve=_nullRequire;var B=_;P=function popper({tests:o="browserify test.js",farm:s="browserstack",notunnel:t=false,runner:n="mocha",browsers:a=[],globals:i="",port:m=1945,watch:l=".",opts:p={},timeout:d,ripple:c}={}){const u=J(d=d||+be.POPPER_TIMEOUT||2e4)(quit),f=3;c=(c||rijs)(F({dir:ge,port:m})(p));ce(c,ge);a=a.map(canonical(s)).filter(Boolean);c("results",{},{from:from});c("totals",{});if(!Ne&&l){ve("watching",l);pe.watch(l,{ignored:[/^\.(.*)[^\/\\]/,/[\/\\]\./,/node_modules(.+)popper/],ignoreInitial:true,usePolling:false,depth:5}).on("change",J(generate))}c(e);c.to=limit(c.to);c.server.on("connected",connected);c.server.express.use(ie()).use("/utilise.min.js",H(local("utilise","utilise.min.js"))).use("/utilise.js",H(local("utilise","utilise.js"))).use("/mocha.css",H(local("mocha","mocha.css"))).use("/mocha.js",H(local("mocha","mocha.js"))).use("/chai.js",H(local("chai","chai.js"))).use("/dashboard/:id",H(local(`./client/${n}/logs.html`))).use("/dashboard",H(local("./client/dashboard.html"))).use("/",ue(local("./client"))).use("/",index());return generate(),spawn(),c;function index(){const e=Y.arr(i)?i.join("\n"):i,r=Q(local(`./client/${n}/index.html`)).replace("\x3c!-- { extra scripts } --\x3e",e||"");return(e,o)=>o.send(r)}function generate(){ve("generating tests");const e=se(local("./client/tests.js")),r=Y.fn(o)?o():te("sh",["-c",o],{stdio:"pipe"});r.stderr&&r.stderr.pipe(B.stderr);((r.stdout||r).on("end",J(500)(reload)).pipe(e).flow||X)()}function from(e){return"RERUN"==e.data.type?reload(e.data.value):"SAVE"==e.data.type&&save(e.socket.platform,e.data.value)}function save(e,r){const{uid:o}=e,s=c("results"),t=o in s?s[o].retries:0;ve("received result from",o);r.platform=e;r.retries=t;Z(o,r)(c("results"));totals();ci(r)}function ci(e){if(!Ne||e.stats.running)return;const r=a.filter(r=>(!r._name||r._name===e.platform.name)&&((!r._version||r._version===e.platform.version)&&((!r._os||r._os===e.platform.os.name)&&(!r._os_version||r._os_version===e.platform.os.version)))).pop();if(!r)return ve("result not in matrix".red,e.platform.uid);r.passed_by=e.platform.uid;r.passed=!e.stats.failures;r.passed?ve("browser passed:",e.platform.uid.green.bold):we("browser failed:",e.platform.uid.red.bold);if(!r.passed&&e.retries<f)return ve("retrying".yellow,e.platform.uid,++e.retries,"/",q(f).grey),reload(e.platform.uid);fe[s].status&&fe[s].status(r,e.platform);const o=a.length,t=a.filter(L("passed")).length,n=a.filter(L("passed_by")).length;ve("ci targets",q(t).green.bold,"/",q(o).grey);o===t?re(3e3,e=>B.exit(0)):o===n?re(3e3,e=>!be.POPPER_TIMEOUT&&B.exit(1)):u()}function connected(e){e.platform=parse$1(e);e.type="/dashboard"==e.handshake.url?"dashboard":"agent";ve("connected",e.platform.uid.green,e.type.grey);e.on("global err",(r,o,s)=>we("Global error: ",e.platform.uid.bold,r,o,s));xe&&e.on("console",(function(){ve(e.platform.uid.bold,"says:","",arguments[0],to.arr(arguments[1]).map(q).join(" "))}))}function quit(){ve("no updates received for",d/1e3,"seconds. timing out..");B.exit(1)}function reload(e){const r=e?[e]:c.server.ws.sockets.map(e=>e.platform.uid);r.map(e=>Z(`${e}.stats.running`,true)(c("results")));const o=c.server.ws.sockets.filter(K(L("handshake.url","/dashboard"))).filter(L("platform.uid",Y.in(r))).map(emitReload).length;ve("reloading",q(o).cyan,"agents",e||"")}function totals(){const e=T(c("results"));return c("totals",{tests:q(e.map($("stats.tests")).filter(Boolean).pop()||"?"),browsers:q(e.length),passing:q(e.map($("stats.failures")).filter(Y(0)).length||"0")})}function spawn(){c.server.once("listening").then(()=>{ve("running on port",c.server.http.address().port);!t&&r.connect(c.server.http.address().port,(e,r)=>{ve("tunnelling",r&&r.magenta);return e?we("error setting up reverse tunnel",e.stack):a.map(boot(s)(r))})})}};const{values:T,key:$,str:q,not:K,by:L,grep:V,lo:G,is:Y,debounce:J,extend:F,falsy:z,send:H,file:Q,noop:X,update:Z,identity:ee,time:re,includes:oe}=o,se=s.createWriteStream,te=t.spawn,{stringify:ne}=n,{resolve:ae}=a,ie=i,me=m,le=l,pe=p,de=d,ce=c,ue=u,fe=M,_e=w,rijs=e=>h(b(e));const ve=v("[popper]"),we=f("[popper]"),he=V(console,"log",/^(?!.*\[ri\/)/),be=B.env,ge=new URL(import.meta.url.slice(0,import.meta.url.lastIndexOf("/"))).pathname,Ne="true"===be.CI,xe="debug"==G(be.NODE_ENV);const heartbeat=e=>setInterval(r=>e.eval("",e=>{e&&console.error(e)}),3e4);const canonical=e=>r=>Y.str(r)?fe[e].browsers[r]:r;const local=(e,r)=>{const o=r?_nullRequire(e):new URL(import.meta.url.slice(0,import.meta.url.lastIndexOf("/"))).pathname,s=r?"../"+r:e;return ae(o,s)};const emitReload=e=>e.send(ne({data:{exec:()=>location.reload()}}));const parse$1=e=>{const r=e.handshake.headers["user-agent"],o=le.parse(r),s={name:G(o.name),version:major(o.version),os:{name:G(o.os.family.split(" ").shift()),version:major(o.os.version,o.os.family)}};"os"==s.os.name&&(s.os.name="osx");"chrome mobile"==s.name&&(s.name="chrome");"microsoft edge"==s.name&&(s.name="ie");const t=s.name+"-"+s.version+"-"+s.os.name+"-"+s.os.version;s.uid=t;return s};const major=(e,r)=>e?e.split(".").shift():oe("xp")(G(r))?"xp":"?";const limit=e=>(r,o)=>"/dashboard"==o.handshake.url&&e(r,o);const boot=e=>r=>o=>{const{_name:s="?",_version:t="?",_os:n="?"}=o,{connect:a,parse:i=ee}=fe[e],m=`${s.cyan} ${t.cyan} on ${n}`,l=o.vm=a(_e);l||(we("failed to connect to "+e),B.exit(1));ve(`booting up ${m}`);l.init(i(o),e=>{if(e)return we(e,m);ve("initialised",m);l.get(r,e=>{if(e)return we(e,m);ve("opened to test page",m.cyan);heartbeat(l)})})};var Se=P;export default Se;

